name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

env:
  GODOT_VERSION: "4.5"
  EXPORT_NAME: multiplayer-minesweeper

jobs:
  export:
    name: Export
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5
    strategy:
      matrix:
        include:
          - platform: Linux
            export_name: multiplayer-minesweeper.x86_64
            artifact_name: linux
          - platform: Windows
            export_name: multiplayer-minesweeper.exe
            artifact_name: windows
          - platform: macOS
            export_name: "Multiplayer Minesweeper.app"
            artifact_name: macos
          - platform: "Linux Server"
            export_name: multiplayer-minesweeper-server.x86_64
            artifact_name: linux-server
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Create build directory
        run: mkdir -p build/${{ matrix.artifact_name }}

      - name: Export ${{ matrix.platform }}
        run: |
          godot --headless --verbose --export-release "${{ matrix.platform }}" build/${{ matrix.artifact_name }}/${{ matrix.export_name }}

      - name: Package macOS app
        if: matrix.platform == 'macOS'
        run: |
          cd build/${{ matrix.artifact_name }}
          zip -r ../macos-multiplayer-minesweeper.zip "Multiplayer Minesweeper.app"

      - name: Upload Linux artifact
        if: matrix.platform == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/${{ matrix.artifact_name }}/${{ matrix.export_name }}
          retention-days: 14

      - name: Upload Windows artifact
        if: matrix.platform == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/${{ matrix.artifact_name }}/${{ matrix.export_name }}
          retention-days: 14

      - name: Upload macOS artifact
        if: matrix.platform == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/macos-multiplayer-minesweeper.zip
          retention-days: 14

      - name: Upload Linux Server artifact
        if: matrix.platform == 'Linux Server'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/${{ matrix.artifact_name }}/${{ matrix.export_name }}
          retention-days: 14

  release:
    name: Create Release
    needs: export
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux
          path: artifacts/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: artifacts/windows

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos
          path: artifacts/macos

      - name: Download Linux Server artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-server
          path: artifacts/linux-server

      - name: Package releases
        run: |
          cd artifacts

          # Linux
          chmod +x linux/multiplayer-minesweeper.x86_64
          zip -j multiplayer-minesweeper-linux.zip linux/multiplayer-minesweeper.x86_64

          # Windows
          zip -j multiplayer-minesweeper-windows.zip windows/multiplayer-minesweeper.exe

          # macOS (already zipped)
          mv macos/macos-multiplayer-minesweeper.zip multiplayer-minesweeper-macos.zip || mv macos/*.zip multiplayer-minesweeper-macos.zip

          # Linux Server
          chmod +x linux-server/multiplayer-minesweeper-server.x86_64
          zip -j multiplayer-minesweeper-server-linux.zip linux-server/multiplayer-minesweeper-server.x86_64

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Multiplayer Minesweeper ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/multiplayer-minesweeper-linux.zip
            artifacts/multiplayer-minesweeper-windows.zip
            artifacts/multiplayer-minesweeper-macos.zip
            artifacts/multiplayer-minesweeper-server-linux.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

